#include <Arduino.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "Audio.h"
#include "driver/i2s.h"

// ===================== 1. Credentials Configuration =====================
const char* ssid             = "YOUR_WIFI_SSID";         // Replace with your WiFi SSID
const char* password         = "YOUR_WIFI_PASSWORD";     // Replace with your WiFi Password

const char* baidu_api_key    = "YOUR_BAIDU_AK";          // Insert Baidu API Key (AK)
const char* baidu_secret_key = "YOUR_BAIDU_SK";          // Insert Baidu Secret Key (SK)

const char* deepseek_key     = "sk-YOUR_DEEPSEEK_KEY";   // Insert DeepSeek Key (must include sk-)

// ===================== 2. Hardware Pin Configuration =====================
// Microphone (INMP441)
#define I2S_SD      16  
#define I2S_WS      15  
#define I2S_SCK     14  

// Speaker Amplifier (MAX98357A)
#define SPK_BCLK    4   
#define SPK_LRC     5   
#define SPK_DOUT    6   

// Button (Using the onboard BOOT button)
#define BUTTON_PIN  0   

// ===================== Global Variables =====================
Audio audio;
String baidu_token = "";
char* record_buffer = NULL; 
int record_size = 0;        
const int MAX_RECORD_SIZE = 1024 * 600; // Max recording buffer (Approx. 15 seconds)
bool is_recording = false;

// ===================== Functional Modules =====================

// 1. Initialize Microphone Recording
void i2s_mic_init() {
  i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
    .sample_rate = 16000, 
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
    .communication_format = I2S_COMM_FORMAT_I2S,
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = 64,
    .use_apll = false,
    .tx_desc_auto_clear = false,
    .fixed_mclk = 0
  };
  i2s_pin_config_t pin_config = {
    .bck_io_num = I2S_SCK,
    .ws_io_num = I2S_WS,
    .data_out_num = -1,
    .data_in_num = I2S_SD
  };
  i2s_driver_install(I2S_NUM_1, &i2s_config, 0, NULL);
  i2s_set_pin(I2S_NUM_1, &pin_config);
}

// 2. Obtain Baidu Authentication Token
void getBaiduToken() {
  HTTPClient http;
  String url = String("https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=") + baidu_api_key + "&client_secret=" + baidu_secret_key;
  http.begin(url);
  int httpCode = http.GET();
  if (httpCode == 200) {
    String payload = http.getString();
    JsonDocument doc;
    deserializeJson(doc, payload);
    baidu_token = String((const char*)doc["access_token"]);
    Serial.println("‚úÖ Baidu Token obtained successfully!");
  } else {
    Serial.println("‚ùå Failed to obtain Baidu Token. Please check your AK and SK!");
  }
  http.end();
}

// 3. Speech-to-Text (Upload audio to Baidu Cloud)
String speechToText() {
  if (baidu_token == "") getBaiduToken();
  if (record_size == 0) return "";

  Serial.println("‚è≥ Uploading audio for Baidu STT recognition...");
  WiFiClientSecure client;
  client.setInsecure();
  if (!client.connect("vop.baidu.com", 443)) return "";

  String url = "/server_api?dev_pid=1537&cuid=ESP32&token=" + baidu_token;
  client.println("POST " + url + " HTTP/1.1");
  client.println("Host: vop.baidu.com");
  client.println("Content-Type: audio/pcm;rate=16000");
  client.print("Content-Length: ");
  client.println(record_size);
  client.println();
  
  uint8_t* p = (uint8_t*)record_buffer;
  size_t left = record_size;
  // Upload audio buffer in chunks to prevent memory overflow
  while(left > 0) {
      size_t chunk = (left > 1024) ? 1024 : left;
      client.write(p, chunk);
      p += chunk;
      left -= chunk;
  }

  String response = "";
  long start = millis();
  while (millis() - start < 6000) {
    delay(1); // üõ°Ô∏è Feed the watchdog to prevent crash/reboot
    if (client.available()) {
      String line = client.readStringUntil('\n');
      if (line == "\r") { 
        String body = client.readString();
        JsonDocument doc;
        deserializeJson(doc, body);
        if (doc.containsKey("result")) return String((const char*)doc["result"][0]);
        break;
      }
    }
  }
  return "";
}

// 4. Request DeepSeek AI (LLM)
String askAI(String text) {
    Serial.println("üß† Calling DeepSeek brain...");
    WiFiClientSecure client;
    client.setInsecure();
    if (!client.connect("api.deepseek.com", 443)) return "Network connection failed";

    JsonDocument doc;
    doc["model"] = "deepseek-chat";
    doc["stream"] = false;
    JsonArray messages = doc["messages"].to<JsonArray>();
    
    JsonObject sysMsg = messages.add<JsonObject>();
    sysMsg["role"] = "system";
    // System Prompt: Instruct AI to answer briefly in Chinese
    sysMsg["content"] = "You are a voice assistant. Please reply in short, conversational Chinese, keeping your response under 30 words."; 

    JsonObject userMsg = messages.add<JsonObject>();
    userMsg["role"] = "user";
    userMsg["content"] = text;

    String requestBody;
    serializeJson(doc, requestBody);

    client.println("POST /chat/completions HTTP/1.1");
    client.println("Host: api.deepseek.com");
    client.println("Authorization: Bearer " + String(deepseek_key));
    client.println("Content-Type: application/json");
    client.print("Content-Length: ");
    client.println(requestBody.length());
    client.println();
    client.println(requestBody);

    String body = "";
    bool isBody = false;
    while(client.connected() || client.available()) {
        delay(1); // üõ°Ô∏è Feed the watchdog
        if (client.available()) {
            String line = client.readStringUntil('\n');
            if(line == "\r") isBody = true;
            else if(isBody) body += line;
        }
    }
    
    int jsonStart = body.indexOf('{');
    if(jsonStart >= 0) {
        String json = body.substring(jsonStart);
        JsonDocument res;
        deserializeJson(res, json);
        return res["choices"][0]["message"]["content"].as<String>();
    }
    return "AI thinking encountered an error";
}

// ===================== Main Setup =====================
void setup() {
  Serial.begin(115200);
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  // 1. Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); }
  Serial.println("\n‚úÖ WiFi connected successfully!");

  // 2. Initialize Speaker Amplifier
  audio.setPinout(SPK_BCLK, SPK_LRC, SPK_DOUT);
  audio.setVolume(10); // üõ°Ô∏è Volume set to 10 to prevent power surge (Brownout)
  audio.connecttohost("https://dict.youdao.com/dictvoice?audio=System+Ready&type=1");

  // 3. Initialize Microphone
  i2s_mic_init();

  // 4. Get Baidu Auth Token
  getBaiduToken();
  
  // 5. Allocate External PSRAM
  record_buffer = (char*)ps_malloc(MAX_RECORD_SIZE); 
  if (record_buffer == NULL) {
      Serial.println("‚ùå Memory allocation failed! Ensure OPI PSRAM is enabled in Arduino Tools!");
  } else {
      Serial.println("‚úÖ System ready! Hold the BOOT button to speak!");
  }
}

// ===================== Main Loop =====================
void loop() {
  audio.loop(); // Keep the audio player running continuously

  // Detect Button Press (BOOT button goes LOW when pressed)
  if (digitalRead(BUTTON_PIN) == LOW) {
    if (!is_recording) {
      is_recording = true;
      record_size = 0;
      audio.stopSong(); // Mute speaker and prepare to listen
      Serial.println("\nüéôÔ∏è [Recording Started] Please speak into the mic...");
    }
    
    // Continuously record audio data into the memory buffer
    if (record_size < MAX_RECORD_SIZE - 1024) {
      size_t bytes_read;
      // üõ°Ô∏è portMAX_DELAY ensures buffer fills completely, preventing frame drops
      i2s_read(I2S_NUM_1, record_buffer + record_size, 1024, &bytes_read, portMAX_DELAY);
      record_size += bytes_read;
    }
  } 
  else { // Button Released
    if (is_recording) {
      is_recording = false;
      Serial.println("‚èπÔ∏è [Recording Ended]");

      if (record_size > 10000) { // Prevent accidental short clicks
        // Step A: Send audio to Baidu STT
        String text = speechToText();
        Serial.println("üó£Ô∏è Recognized Text: " + text);

        if (text.length() > 0) {
          // Step B: Send text to DeepSeek LLM
          String reply = askAI(text);
          Serial.println("ü§ñ AI Reply: " + reply);

          // Step C: URL Encode and fetch TTS audio
          String urlEncoded = "";
          for (int i = 0; i < reply.length(); i++) {
               if (isalnum(reply[i])) urlEncoded += reply[i];
               // üõ°Ô∏è Cast to uint8_t to prevent negative value hex encoding issues
               else urlEncoded += "%" + String((uint8_t)reply[i], HEX);
          }
          String tts = "https://dict.youdao.com/dictvoice?audio=" + urlEncoded + "&type=1&le=zh";
          audio.connecttohost(tts.c_str());
        } else {
          Serial.println("‚ùå Could not hear clearly.");
        }
      }
    }
  }
}

// Required callback function for the ESP32-audioI2S library
void audio_info(const char *info){ }
